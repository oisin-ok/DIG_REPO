---
title: "Assignment 4 - Data Exploration"
author: "Oisín O'Keeffe, id=24251901"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

## Introduction
The DIG (Digitalis Investigation Group) Trial was a randomized, double-blind, multicenter trial with more than 300 centers in the United States and Canada participating. The purpose of the trial was to examine the safety and efficacy of Digoxin in treating patients with congestive heart failure in sinus rhythm. Digitalis was introduced clinically more than 200 years ago and has since become a commonly prescribed medication for the treatment of heart failure; however, there was considerable uncertainty surrounding its safety and efficacy. Small trials indicated that Digoxin alleviated some of the symptoms of heart failure, prolonged exercise tolerance, and generally improved the quality of patients' lives. Unfortunately, these trials were generally small and although they did focus on the effect of treatment on patients’ relief from heart failure symptoms and quality of life, they failed to address the effect of treatment on cardiovascular outcomes. Questions about the safety of Digoxin were also a concern. Digoxin toxicity is uncommon in small trials with careful surveillance, however, the long-term effects of therapeutic levels of Digoxin were less clear.

The DIG dataset consists of baseline and outcome data from the main DIG trial. In the main
trial, heart failure patients meeting the eligibility criterion and whose ejection fraction was 45%
or less were randomized to receive either a placebo or digoxin. Outcomes assessed in the trial
included: cardiovascular mortality, hospitalization or death from worsening heart failure,
hospitalization due to other cardiovascular causes and hospitalization due to non-cardiovascular
causes.

The **DIG** dataset was obtained for the purpose of this assignment and is enclosed with this assignment. The codebook associated with the variables is also enclosed with your assignment.


In order to create an anonymous dataset that protects patient confidentiality, most variables have been permuted over the set of patients within treatment group. Therefore, it would be inappropriate to use this dataset for other research or publication purposes. 

## Instructions
Change my name and id to yours in YAML above and complete the tasks below by inserting the required code in the R chunks provided under each task. Then knit the document to generate a html document with your solutions.

## Data Management

### Task 1 
- Read in the csv file `DIG.csv` provided in your assignment and call it `dig.df`.

- Select the following variables from the data: `ID, TRTMT, AGE, SEX, BMI, KLEVEL, CREAT, DIABP, SYSBP` and `HYPERTEN, CVD, WHF, DIG, HOSP, HOSPDAYS, DEATH, DEATHDAY`.

- And convert each column to a datatype that is most relevant. i.e. characters to character, numbers to numeric, etc.

```{r}
## Insert your code here

#load libraries
library(tidyverse)
library(table1)
library(ggplot2)
library(ggmosaic)
library(plotly)
library(survival)
library(gridExtra)
library(grid)
library(viridis)

#read in the CSv file
dig.df <- read.csv("DIG.csv")

#select variables
dig.df <- dig.df %>%
  select(ID, TRTMT, AGE, SEX, BMI, KLEVEL, CREAT, DIABP, SYSBP, HYPERTEN, CVD, WHF, DIG, HOSP, HOSPDAYS, DEATH, DEATHDAY)


#convert variables to relevant data types
dig.df$TRTMT <- as.factor(dig.df$TRTMT)
dig.df$SEX <- as.factor(dig.df$SEX)
dig.df$HYPERTEN <- as.factor(dig.df$HYPERTEN)
dig.df$CVD <- as.factor(dig.df$CVD)
dig.df$WHF <- as.factor(dig.df$WHF)
dig.df$DIG <- as.factor(dig.df$DIG)
dig.df$HOSP <- as.factor(dig.df$HOSP)
dig.df$DEATH <- as.factor(dig.df$DEATH)

#check for NA values
sapply(dig.df, function(x) sum(is.na(x)))
```

### Task 2 
- Using the codebook provided, label the factor variables in the data appropriately.

```{r}
levels(dig.df$SEX) <- c("Male", "Female")
levels(dig.df$TRTMT) <- c("Placebo", "Drug")
levels(dig.df$HYPERTEN) <- c("No", "Yes") # History of Hypertension
levels(dig.df$CVD) <- c("No", "Yes") # Hospitalisation due to Cardiovascular Disease
levels(dig.df$WHF) <- c("No", "Yes") # Hospitalisation due to Worsening Heart Failure
levels(dig.df$DIG) <- c("No", "Yes") # Hospitalisation due to Digoxin Toxicity
levels(dig.df$HOSP) <- c("No", "Yes") # Hospitalisation (any)
levels(dig.df$DEATH) <- c("Alive", "Dead") # Vital status of patient

head(dig.df)
```

## Data Exploration

Use both appropriate **summary statistics** and **visualisation** to answer the questions below.

- **Note:** you must use appropriate labeling, captions and legends for your graphics and tables.

- **Note:** you must use alternative colouring than the default coloring for your plots. 

- **Note:** you must **interpret** all your summaries and figures in order to answer the question that was asked. 

- **Note:** where appropriate use interactive graphics. 

- **Hint:** package **table1** could be quite helpful in obtaining summary statistics. For more info visit [here](https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html).


#### Question 1:
Summarise the number (and proportion) of patients hired within each treatment group.

```{r}
## Insert your code here

# summarise number and proportion of people hired in each group
recruits <- dig.df %>%
  group_by(TRTMT) %>%
  summarise(number = n(), .groups = "drop") %>%
  mutate(prop = number/sum(number))

recruits


# visualisation: pie chart
recruits_pie <- plot_ly(
  data = recruits,
  labels = ~TRTMT,
  values = ~prop,
  text = ~number,
  type = "pie",
  textinfo = "label+percent+text",
  hoverinfo = "label+value+percent"
) %>%
  layout(
    
    #set the title of the chart
    title = list(
      text = "Proportion of Patients in each Treatment Group",
      font = list(
        size = 24,
        colour = "black"
      )
      
    ),
    
    #adjust the legend positioning
    legend = list(
      font = list(size = 18),
      x = 1.1, y = 0.5,
      xanchor = "left", yanchor = "middle"
    ),
    
    #make more room for the title
    margin = list(t = 80)
  )

recruits_pie

```

_**Interpretation**_ .....
We can see from the summary table and the pie chart that the two treatment groups are almost the exact same size - we can see from the counts that there is a different of only 6 between the groups, and hovering over sections of the pie chart reveals more precise proportions.




#### Question 2:
Assess if there is any significant differences in base-line characteristics (e.g. Age, Sex, BMI, ...) between the patients assigned to digoxin and patients assigned to placebo and comment on any unusual pattern you see:

```{r}
## Insert your code here


#generate summary statistics for base-line characteristics
table1( ~ AGE + SEX + BMI + KLEVEL + CREAT + DIABP + SYSBP + HYPERTEN| TRTMT, data = dig.df)


#Visualisations

# Categorical Variables
#SEX
sex.plot <- dig.df %>%
  select(TRTMT, SEX) %>%
  na.omit() %>%
  ggplot(mapping = aes(x = TRTMT, y = 100*(after_stat(count))/sum(after_stat(count)), fill = SEX)) + 
  geom_bar(position = "fill") +
  scale_fill_manual(values = c("Male" = "lightblue", "Female" = "pink")) +
  labs(title = "Sex Prop. by Treatment",
       fill = "Participant Sex", 
       x = "Treatment Group", 
       y= "Percentage (%)")


#HYPERTEN
hyperten.plot <- dig.df %>%
  select(TRTMT, HYPERTEN) %>%
  na.omit() %>%
  ggplot(mapping = aes(x = TRTMT, y = 100*(after_stat(count))/sum(after_stat(count)), fill = HYPERTEN)) + 
         geom_bar(position = "fill") +
         scale_fill_manual(values = c("No" = "darkorange", "Yes" = "cornflowerblue")) +
         labs(title = "Hypertension Prop. by Treatment",
              fill = "Hypertension History", 
              x = "Treatment Group", 
              y= "Percentage (%)") +
        theme(plot.margin = margin(10, 10, 10, 10))

grid.arrange(sex.plot, hyperten.plot,
             nrow=1, ncol=2,
             top = textGrob("Barplot of Categorical Variables by Treatment Group", gp = gpar(fontsize = 14, fontface = "bold")),
             bottom = textGrob("Source: Digitalis Investigation Group Trial", gp = gpar(fontsize = 10, fontface = "italic"))
             )
```



```{r}
# Continuous Variables

#AGE
age.plot <- dig.df %>%
  select(TRTMT, AGE) %>%
  na.omit() %>%
  ggplot(aes(x = TRTMT, y = AGE, fill = TRTMT,)) +
    geom_boxplot() +
    scale_fill_manual(values = c("Placebo" = "yellow", "Drug" = "blue")) +
    labs(title = "Age by Treatment",
         x = "Treatment Group",
         y = "Age (years)") +
    theme_bw()

#BMI
bmi.plot <- dig.df %>%
  select(TRTMT, BMI) %>%
  na.omit() %>%
  ggplot(aes(x = TRTMT, y = BMI, fill = TRTMT,)) +
    geom_boxplot() +
    scale_fill_manual(values = c("Placebo" = "yellow", "Drug" = "blue")) +
    labs(title = "BMI by Treatment",
         x = "Treatment Group",
         y = "BMI") +
    theme_bw()

#KLEVEL
klevel.plot <- dig.df %>%
  select(TRTMT, KLEVEL) %>%
  na.omit() %>%
  ggplot(aes(x = TRTMT, y = KLEVEL, fill = TRTMT,)) +
    geom_boxplot() +
    scale_fill_manual(values = c("Placebo" = "yellow", "Drug" = "blue")) +
    labs(title = "KLEVEL by Treatment",
         x = "Treatment Group",
         y = "Serum Potassium (mmol/L)") +
    theme_bw()

#CREAT
creat.plot <- dig.df %>%
  select(TRTMT, CREAT) %>%
  na.omit() %>%
  ggplot(aes(x = TRTMT, y = CREAT, fill = TRTMT,)) +
    geom_boxplot() +
    scale_fill_manual(values = c("Placebo" = "yellow", "Drug" = "blue")) +
    labs(title = "CREAT by Treatment",
         x = "Treatment Group",
         y = "Serum Creatinine (mg/dL)") +
    theme_bw()
  

#DIABP
diabp.plot <- dig.df %>%
  select(TRTMT, DIABP) %>%
  na.omit() %>%
  ggplot(aes(x = TRTMT, y = DIABP, fill = TRTMT,)) +
    geom_boxplot() +
    scale_fill_manual(values = c("Placebo" = "yellow", "Drug" = "blue")) +
    labs(title = "DIABP by Treatment",
         x = "Treatment Group",
         y = "Diastolic BP (mmHg)") +
    theme_bw()

#SYSBP
sysbp.plot <- dig.df %>%
  select(TRTMT, SYSBP) %>%
  na.omit() %>%
  ggplot(aes(x = TRTMT, y = SYSBP, fill = TRTMT,)) +
    geom_boxplot() +
    scale_fill_manual(values = c("Placebo" = "yellow", "Drug" = "blue")) +
    labs(title = "SYSBP by Treatment",
         x = "Treatment Group",
         y = "Systolic BP (mmHg)") +
    theme_bw()


# Interactive Plots

ggplotly(age.plot, tooltip = c("x", "y", "text"))
ggplotly(bmi.plot, tooltip = c("x", "y", "text"))
ggplotly(klevel.plot, tooltip = c("x", "y", "text"))
ggplotly(creat.plot, tooltip = c("x", "y", "text"))
ggplotly(diabp.plot, tooltip = c("x", "y", "text"))
ggplotly(sysbp.plot, tooltip = c("x", "y", "text"))


# Summarised View
grid.arrange(age.plot + theme(legend.position = "none"),
             bmi.plot + theme(legend.position = "none"),
             klevel.plot + theme(legend.position = "none"),
             creat.plot + theme(legend.position = "none"),
             diabp.plot + theme(legend.position = "none"),
             sysbp.plot + theme(legend.position = "none"),
             nrow=2, ncol=3,
             top = textGrob("Boxplots of Continuous Variables by Treatment Group", gp = gpar(fontsize = 14, fontface = "bold")),
             bottom = textGrob("Source: Digitalis Investigation Group Trial", gp = gpar(fontsize = 10, fontface = "italic"))
             )

```


_**Interpretation**_ .....

We can see from our summary table and graphs that the mean, standard deviation, median, and range of the data is approximately equal for almost all variables across both treatment groups. There are an excess of men over women, but these proportions are reflected between treatment groups and so should not confound results.

A notable exception to the otherwise equal statistics is Serum Potassium Level (KLEVEL). We see that the mean of KLEVEL is different between Placebo and Control, and that the mean in Placebo is pulled above the median and the standard deviation is considerably higher than for the Drug cohort, suggesting the data is non-symmetric. From the boxplot we see that there is a recording for Serum Potassium Level (KLEVEL) that far exceeds the range of the other values. This is likely an error in recording and of no biological significance, as Serum Potassium Levels in this range would be fatal (https://www.mayoclinic.org/symptoms/hyperkalemia/basics/definition/sym-20050776). We can therefore remove this data point and recalculate summary statistics and graphs as follows:

```{r}

#check number of valid KLEVEL observations before removal
dig.df %>%
  select(TRTMT, KLEVEL) %>%
  na.omit() %>%
  nrow()

#remove extreme value in KLEVEL > 400
dig_clean.df <- dig.df %>%
  select(TRTMT, KLEVEL) %>%
  na.omit() %>%
  filter(KLEVEL < 100)

#confirm outlier removal 
nrow(dig_clean.df)

#updated summary statistics for KLEVEL
table1( ~ KLEVEL | TRTMT, data = dig_clean.df)

#plot KLEVEL
klevel.plot <- dig_clean.df %>%
  select(TRTMT, KLEVEL) %>%
  na.omit() %>%
  ggplot(aes(x = TRTMT, y = KLEVEL, fill = TRTMT,)) +
    geom_boxplot() +
    scale_fill_manual(values = c("Placebo" = "yellow", "Drug" = "blue")) +
    labs(title = "Boxplot of KLEVEL by Treatment Group",
         x = "Treatment Group",
         y = "KLEVEL",
         caption = "Source: Digitalis Investigation Group Trial") +
    theme_bw()
    

ggplotly(klevel.plot, tooltip = c("y"))

```
Now we can see that the data in the 'Placebo' group covers a much more reasonable range and has summary statistics quite similar to those of the 'Drug' group.



#### Question 3:

Assess if the overall mortality was affected by the treatment.

```{r}
## Insert your code here

#summary statistics
table1( ~ DEATH | TRTMT, data = dig.df)

#mosaic plot
dig.df %>%
  select(TRTMT, DEATH) %>%
  na.omit() %>%
  table() %>% 
  mosaicplot(main="Mosaic Plot of Treatment vs Mortality",
             colour = c("turquoise", "chartreuse"),
             xlab = "Treatment Group",
             ylab = "Mortality")

grid.text("Source: Digitalis Investigation Group Trial", 
          x = 0.5, y = 0.05,
          gp = gpar(fontsize = 10, fontface = "italic"))
```

_**Interpretation**_ .....

We can see from the summary statistics and the mosaic plot the the number of people who survive and die are approximately equal between the two treatment groups, suggesting that, over the course of this experiment, the treatment did not affect overall mortality.



#### Question 4:

Assess if the Cardiovascular disease (`CVD`) is associated with the mortality overall and also within each treatment group.

```{r}
## Insert your code here

#summary statistics
table1( ~ CVD | TRTMT + DEATH, data = dig.df)


#graphs

#within treatment groups
dig.df %>%
  select(TRTMT, CVD, DEATH) %>%
  na.omit() %>%
  ggplot(mapping = aes(x = CVD, y = 100*(after_stat(count))/sum(after_stat(count)), fill = DEATH)) + 
    geom_bar(position = "fill") +
    facet_wrap(~ TRTMT) +
    labs(title = "Barplot of Association between CVD and Mortality by Treatment",
         fill = "Mortality", 
         caption = "Source: Digitalis Investigation Group Trial",
         x = "Cardiovascular Disease Hospitalisation", 
         y= "Percentage (%)") +
    scale_x_discrete(labels = c("No" = "No CVD", "Yes" = "CVD")) +
    scale_fill_manual(values = c("Dead" = "red", "Alive" = "skyblue")) +
    theme_bw()


#overall
dig.df %>%
  select(CVD, DEATH) %>%
  na.omit() %>%
  ggplot(mapping = aes(x = CVD, y = 100*(after_stat(count))/sum(after_stat(count)), fill = DEATH)) + 
    geom_bar(position = "fill") +
    labs(title = "Barplot of Association between CVD and Mortality Overall",
         fill = "Mortality", 
         caption = "Source: Digitalis Investigation Group Trial",
         x = "Cardiovascular Disease Hospitalisation", 
         y= "Proportion") +
    scale_x_discrete(labels = c("No" = "No CVD", "Yes" = "CVD")) +
    scale_fill_manual(values = c("Dead" = "red", "Alive" = "skyblue")) +
    theme_bw()
```

_**Interpretation**_ .....

Our summary statistics shows that there is a difference in the proportions of people who have died and survived between the groups who have been hospitalised due to cardiovascular disease and those who have not. The increased proportion of dead people in the CVD positive group implies that people who have been hospitalised for cardiovascular disease are more likely to die than those who have not, however as we can see in the stacked barcharts, this effect does not seem to differ between the treatment groups, suggesting that digoxin is not contributing to this effect.



#### Question 5:

Assess if the hospitalizations was affected by the treatment.

```{r}
## Insert your code here

#summary statistics
table1(~ HOSP | TRTMT, data = dig.df)

#graph
dig.df %>%
  select(TRTMT, HOSP) %>%
  na.omit() %>%
  ggplot(mapping = aes(x = TRTMT, y = 100*(after_stat(count))/sum(after_stat(count)), fill = HOSP)) + 
    geom_bar(position = "fill") +
    labs(title = "Barplot of Association between Treatment and Hospitalisation",
         fill = "Hospitalisation", 
         caption = "Source: Digitalis Investigation Group Trial",
         x = "Treatment Group", 
         y= "Proportion Hospitalised") +
    scale_fill_manual(values = c("No" = "purple", "Yes" = "orange")) +
    theme_bw()

```

_**Interpretation**_ .....

There is a very small decrease in the proportion of people hospitalised who are in the 'Drug' group, however it is not clear whether this is a statistically significant difference without further analysis.


#### Question 6
Assess if the Worsening heart failure (`WHF`) is associated with the hospitalizations overall and also within each treatment group:

```{r}
## Insert your code here

#summary statistics
table1( ~ WHF | TRTMT + HOSP, data = dig.df)


#graphs

#within treatment groups
dig.df %>%
  select(TRTMT, HOSP, WHF) %>%
  na.omit() %>%
  ggplot(mapping = aes(x = HOSP, y = 100*(after_stat(count))/sum(after_stat(count)), fill = WHF)) + 
    geom_bar(position = "fill") +
    facet_wrap(~ TRTMT) +
    labs(title = "Association between Hospitalisation and Worsening Heart Failure by Treatment",
         fill = "Worsening Heart Failure", 
         caption = "Source: Digitalis Investigation Group Trial",
         x = "Hospitalisation", 
         y= "Percentage (%) due to Worsening Heart Failure") +
    scale_fill_manual(values = c("Dead" = "red", "Alive" = "skyblue")) +
    theme_bw()

#overall
dig.df %>%
  select(TRTMT, HOSP, WHF) %>%
  na.omit() %>%
  ggplot(mapping = aes(x = HOSP, y = 100*(after_stat(count))/sum(after_stat(count)), fill = WHF)) + 
    geom_bar(position = "fill") +
    labs(title = "Association between Hospitalisation and Worsening Heart Failure by Treatment",
         fill = "Worsening Heart Failure", 
         caption = "Source: Digitalis Investigation Group Trial",
         x = "Hospitalisation", 
         y= "Percentage (%) due to Worsening Heart Failure") +
    scale_fill_manual(values = c("Dead" = "red", "Alive" = "skyblue")) +
    theme_bw()

```

_**Interpretation**_ .....

The first thing we notice is that there is a perfect correlation between people who have not been hospitalised and people who have not been hospitalised due to worsening heart failure - this of course must occur due to the definition of these variables - anyone who has been hospitalised due to worsening heart failure has been hospitalised in general, which we see as a solid block in our stacked bar chart.

For people who have been generally hospitalised, we see that 46.8% of these include worsening heart failure as a reason for hospitalisation, and 53.2% do not. When we divide this by treatment groups, we see that people in the 'Placebo' group attribute their hospitalisation (at least in part) due to worsening heart failure more often, while slightly fewer people in the 'Drug' group are hospitalised with the symptom of worsening heart failure. This suggests that the drug may potentially be reducing worsening heart failure to a greater extent than the placebo. 



#### Question 7:

Create a new variable `Month` by dividing the variable `DEATHDAY` to 30 and round it to the nearest whole number.

```{r}
## Insert your code here
dig.df <- dig.df %>%
  mutate(Month = round(DEATHDAY/30))

#validate
names(dig.df)
```

#### Question 8:

Summarise the variable `Month` created above.

```{r}
## Insert your code here
summary(dig.df$Month)

# Visualise
plot_ly(data = dig.df,
       y = ~Month,
       type = "box",
       fillcolor = "darkred",
       line = list(color = "black"),
       name = "All Particants") %>%
  layout(
    title = "Boxplot of Particpant Time in Study",
    yaxis = list(
      title = "Length of Time Enrolled in Study (months)",
      showgrid = TRUE
    ),
    
    # caption plot
    annotations = list(
      text = "Source: Digitalis Investigation Group Trial", 
      x = 0.5,
      y = -0.1,  
      xref = "paper", 
      yref = "paper",
      showarrow = FALSE,
      align = "center"
    )
  )

plot_ly(data = dig.df, 
        x = ~Month, 
        type = "histogram",
        marker = list(color = "skyblue",
                      line = list(color = "pink",
                                  width = 2)
                      )
        ) %>%
  layout(
    title = "Histogram of Partipant Time in Study",
    xaxis = list(title = "Months Enrolled"),
    yaxis = list(title = "Frequency"),
    showlegend = FALSE
  )
```

_**Interpretation**_ .....

This new variable identifies the number of months a patient was in the study, from beginning to when they either died or dropped out. We can see from the summary statistics, which are visualised in the box plot, that minimum time spent in the study was 0 months, while the maximum was 59. The mean time in months spent enrolled in the study is 35.45, while the median is slightly higher - this difference implies a non-normal distribution that is skewed left, and so I investigated the distribution of the data through an interactive histogram. We can see here that there is a relatively low proportion of people who spend less than 29 months in the study, while a much larger proportion spend more 29 or more months enrolled. This distribution suggests that the DIG study enrolled people for a standard 30 months, and that the relatively uniform distribution we see preceding the 30 month mark is due to people dropping out or dying prior prior to the end of the study. The distribution becomes relatively uniform following this point, again suggesting a relatively steady rate of combined death/drop out.


#### Question 9:

Summarise the risk of mortality within each month.

**HINT:** you may want to use `survfit` function in **Survival** package to extract required mortality rate within each month. For an example see [here](https://www.rdocumentation.org/packages/survival/versions/3.5-7/topics/summary.survfit)

```{r}
## Insert your code here
#install.packages("survival")
#

mort_month<-summary(survfit(Surv(Month, DEATH) ~ 1, data = dig.df))

mortality.df <- data.frame(Month = mort_month$time, # Extract month
                           Enrolled = mort_month$n.risk[,1], # Extract number enrolled at beginning of each month
                           Deaths = mort_month$n.event[,2], # Extract number of people who died (finished trial and died)
                           Cum_Prob_Death = mort_month$pstate[,2]) # Extract the cumulative probability of death at each month

mortality.df <- mutate(mortality.df, Monthly_Risk = Deaths/Enrolled)

head(mortality.df)


#summary statistics of deaths
mortality.df %>%
  select(Deaths, Monthly_Risk) %>%
  summary()



#Visualise

#Deaths per month
plot_ly(data = mortality.df, 
        x = ~Month,
        y = ~Deaths,
        type = "bar",
        marker = list(color = "darkred"),
        text = ~paste("Month: ", Month, "<br>Deaths: ", Deaths),
        hoverinfo = "text",
        textposition = "none"
) %>%
  layout(
    title = "Distribution of Deaths Over 59 Months",
    xaxis = list(title = "Month", dtick = 1), 
    yaxis = list(title = "Number of Deaths"), 
    bargap = 0.1 
  )

#Risk of death per month
plot_ly(data = mortality.df, 
        x = ~Month,
        y = ~Monthly_Risk,
        type = "scatter",
        mode = "lines+markers",
        line = list(color = "blue"),
        marker = list(color = "darkred"),
        text = ~paste("Month: ", Month, "<br>Risk of Mortality: ", round(Monthly_Risk, 4)),
        hoverinfo = "text") %>%
  layout(
    title = "Distribution of Instant Risk of Death Over 59 Months",
    xaxis = list(title = "Month"),  
    yaxis = list(title = "Risk of Dying",
                 range = c(0, max(mortality.df$Monthly_Risk))) 
  )

mortality.df
```



_**Interpretation**_ .....

We can see from our summary statistics that the mean number of deaths in a month is less than the median, which might mean people are more likely to die at the beginning of the trial due to a skew in the data. However, we can see by plotting the risk of death in each month that this is actually quite eratic (it spikes towards the end mainly due to how few people remain in the trial at month 59 (Enrolled = 61, Deaths = 1)). Overall, our data suggests that the overall instantaneous (rather than cumulative) mortality risk remains relatively constant throughout the duration of the trial, as seen by the fairly narrow interquartile range in summary statistics.


#### Question 10:

Summarise the risk of mortality within each month and for each treatment group.



```{r}
## Insert your code here
library(tidyr)

#summarise survival stats
mort_grp_month<-summary(survfit(Surv(Month, DEATH) ~ TRTMT, data = dig.df))

#extract relevant data into a summary dataframe
mortality_group.df <- data.frame(Month = mort_grp_month$time,
                                 Treatment = mort_grp_month$strata,
                                 Enrolled = mort_grp_month$n.risk[,1],
                                 Deaths = mort_grp_month$n.event[,2],
                                 Cum_Prob_Death = mort_grp_month$pstate[,2])

mortality_group.df <- mutate(mortality_group.df, Monthly_Risk = Deaths/Enrolled)

levels(mortality_group.df$Treatment) <- c("Placebo", "Drug")

#Validate
head(mortality_group.df)

#Summary statistics

#for placebo group
mortality_group.df %>%
  filter(Treatment == 'Placebo') %>%
  select(Deaths, Monthly_Risk) %>%
  summary()

#for drug group
mortality_group.df %>%
  filter(Treatment == 'Drug') %>%
  select(Deaths, Monthly_Risk) %>%
  summary()

# Visualisations

#Cumulative Probability of Death
ggplot(mortality_group.df, aes(x = Month, y = Cum_Prob_Death, colour = Treatment)) +
  geom_line(size = 1) + 
  labs(title = "Cumulative risk of Death for each Month",
       x = "Month",
       y="Probability of Dying",
       colour = "Treatment") +
  scale_colour_manual(values = c("lightblue", "pink")) +
  theme_bw()


# Deaths per Month
death_plot <- ggplot(mortality_group.df, aes(x = Month, y = Deaths, fill = Treatment)) +
  geom_histogram(stat = "identity", position = "dodge") + 
  labs(title = "Deaths by Month",
       x = "Month of Study",
       y = "Number of Deaths",
       fill = "Treatment Group") +
  scale_fill_manual(values = c("Placebo" = "yellow", "Drug" = "blue")) + 
  theme_minimal()

# make interactive, add tooltips
ggplotly(death_plot, tooltip = c("x", "y", "fill"))

# Mortality Risk per Month
plot_ly(data = mortality_group.df, 
        x = ~Month,
        y = ~Monthly_Risk,
        type = "scatter",
        mode = "lines+markers",
        color = ~Treatment,
        split = ~Treatment,
        colors = c("Drug" = "blue", "Placebo" = "yellow"),
        text = ~paste("Month: ", Month, "<br>Risk of Mortality: ", round(Monthly_Risk, 4)),
        hoverinfo = "text") %>%
  layout(
    title = "Distribution of Instant Risk of Death Over 59 Months by Treatment",
    xaxis = list(title = "Month"),  
    yaxis = list(title = "Risk of Dying",
                 range = c(0, max(mortality_group.df$Monthly_Risk))),
    legend = list(title = list(text="Treatment Group"))
  )
```


_**Interpretation**_ .....

We can see clearly that the mean number of deaths per month in either treatment group are approximately equal, and both groups have a similar interquartile range. The same is true for the mortality risk per month. The cumulative mortality risk for someone starting the study is shown in the line plot which shows that the risk of having died by a particular month after starting the study increases linear throughout for both treatment groups, indicating no effect of the drug on long term survival. We can see the same pattern of gradually decreasing deaths throughout the study, as the number of people enrolled continues to drop. The (instantaneous) monthly risk of death, calculated as the proportion of people who died at individual timepoints throughout the study, is similarly erratic and not seemingly affected by the drug, suggesting it is having no effect on survival throughout the duration of the trial.



#### Question 11:
 Assess the effect of `CVD` on the risk of mortality within each month and for each treatment group:


```{r}
#group data
mortality_group_cvd.df <- dig.df %>%
  select(ID, Month, TRTMT, CVD, DEATH) %>%
  na.omit() %>%
  group_by(Month, Treatment = TRTMT, CVD) %>%
  summarise(
    Deaths = sum(DEATH == "Dead"),
    Enrolled = n()
  ) %>%
  mutate(Monthly_Risk = Deaths / Enrolled)

#summarise
table1(~Monthly_Risk | Treatment + CVD, data = mortality_group_cvd.df)

  
```


_**Interpretation**_ .....

#### Question 12:

Assess if there is any linear relationship between systolic and diastolic blood pressures? Is this relationship affected by the treatment the patients received or whether patients have hypertension or not?

```{r}
## Insert your code here

# scatterplot of overall relationship 
plot_ly(data = dig.df,
        x = ~DIABP,
        y = ~SYSBP,
        type = "scatter",
        mode = "markers",
        text = ~paste("Diastolic BP: ", DIABP, "<br>Systolic BP: ", SYSBP),
        hoverinfo = "text",
        colors = c("Yes" = "orange", "No" = "blue")
) %>%
  layout(
    title = "Diastolic vs. Systolic Blood Pressure Overall",
    xaxis = list(title = "Diastolic Blood Pressure (mmHg)"),
    yaxis = list(title = "Systolic Blood Pressure (mmHg)")
  )



# by Treatment Group
plot_ly(data = dig.df,
        x = ~DIABP,
        y = ~SYSBP,
        type = "scatter",
        mode = "markers",
        split = ~TRTMT,
        text = ~paste("Diastolic BP: ", DIABP, "<br>Systolic BP: ", SYSBP, "<br>Treatment: ", TRTMT),
        hoverinfo = "text",
        colors = c("Placebo" = "yellow", "Drug" = "blue")
) %>%
  layout(
    title = "Diastolic vs. Systolic Blood Pressure by Treatment Group",
    xaxis = list(title = "Diastolic Blood Pressure (mmHg)"),
    yaxis = list(title = "Systolic Blood Pressure (mmHg)"),
    legend = list(title = list(text = "Treatment Group"))
  )

# by Hypertension History
plot_ly(data = dig.df,
        x = ~DIABP,
        y = ~SYSBP,
        type = "scatter",
        mode = "markers",
        split = ~HYPERTEN,
        text = ~paste("Diastolic BP: ", DIABP, "<br>Systolic BP: ", SYSBP, "<br>Hypertension History: ", HYPERTEN),
        hoverinfo = "text",
        colors = c("Yes" = "pink", "No" = "skyblue")
) %>%
  layout(
    title = "Diastolic vs. Systolic Blood Pressure by Hypertension History",
    xaxis = list(title = "Diastolic Blood Pressure (mmHg)"),
    yaxis = list(title = "Systolic Blood Pressure (mmHg)"),
    legend = list(title = list(text = "Hypertension History"))
  )

```

_**Interpretation**_ .....
It is evident from the scatterplots that there is no linear relationship between systolic and diastolic blood pressure. Treatment and hypertension are having no effect on the relationship between these two variables.
